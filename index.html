<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flexi CBT – Candidate Login</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { font-family: sans-serif; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; background:#f4f6f4; }
.container { background:#fff; padding:30px; width:90%; max-width:400px; border-radius:12px; text-align:center; box-shadow:0 10px 25px rgba(0,0,0,0.1); }
h2 { color:#0b6623; }
input { width:100%; padding:12px; margin:15px 0; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; }
button { width:100%; padding:12px; background:#0b6623; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
button:disabled { background:#ccc; }
.status { margin-top:15px; font-size:14px; }
</style>
</head>
<body>

<div class="container">
  <h2>Candidate Login</h2>
  <p>Enter your WhatsApp number to validate your exam access</p>
  <input type="tel" id="waInput" placeholder="WhatsApp number (e.g. 08062244119)">
  <input type="text" id="candidateNameInput" placeholder="Your full name">
  <button id="startExamBtn">Start Exam</button>
  <div class="status" id="status"></div>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {

  // ===== FIREBASE CONFIG =====
  const firebaseConfig = {
    apiKey: "AIzaSyCPumFid5YNTWug52q2VDtSDQTLU9REgss",
    authDomain: "flexi-tutors.firebaseapp.com",
    projectId: "flexi-tutors",
    storageBucket: "flexi-tutors.firebasestorage.app",
    messagingSenderId: "320176672406",
    appId: "1:320176672406:web:90f19511241e51c6437cb7"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ===== DOM ELEMENTS =====
  const waInput = document.getElementById("waInput");
  const nameInput = document.getElementById("candidateNameInput");
  const startBtn = document.getElementById("startExamBtn");
  const status = document.getElementById("status");

  function formatName(name){
    return name.trim().split(" ").map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(" ");
  }

  // ===== CHECK EXAM TIME =====
  async function checkExamTime(){
    const configDoc = await db.collection("settings").doc("examConfig").get();
    if(!configDoc.exists){
      status.style.color="#b30000";
      status.textContent = "⚠️ Exam not configured by admin.";
      return false;
    }
    const now = new Date(new Date().toLocaleString("en-US",{timeZone:"Africa/Lagos"}));
    const start = new Date(configDoc.data().startTime);
    const end = new Date(configDoc.data().endTime);

    if(now < start){
      status.style.color="#0b6623";
      status.textContent = "⏳ Exam has not started yet.";
      return false;
    }
    if(now > end){
      status.style.color="#b30000";
      status.textContent = "⛔ Exam closed.";
      return false;
    }
    status.textContent = "";
    return true;
  }
// ... (Keep your Firebase config and DOM elements as they are)

  // ===== START EXAM =====
  startBtn.addEventListener("click", async ()=>{
    const wa = waInput.value.trim();
    const name = nameInput.value.trim();
    if(!wa || !name){ 
      status.style.color="#b30000";
      status.textContent="⚠️ Fill all fields"; 
      return; 
    }

    startBtn.disabled = true;
    status.style.color="#0b6623";
    status.textContent = "⏳ Validating...";

    try{
      // 1️⃣ Check exam time
      const allowed = await checkExamTime();
      if(!allowed){ startBtn.disabled=false; return; }

      // 2️⃣ Check subscription by WhatsApp number
      const subRef = db.collection("subscriptions").doc(wa);
      const subSnap = await subRef.get();

      if(!subSnap.exists){
        status.style.color="#b30000";
        status.textContent="❌ Number not registered";
        startBtn.disabled=false;
        return;
      }

      const subData = subSnap.data();

      if(subData.paid !== true){
        status.style.color="#b30000";
        status.textContent="❌ Payment not confirmed";
        startBtn.disabled=false;
        return;
      }

      if(subData.used === true){
        status.style.color="#b30000";
        status.textContent="❌ The PIN linked to this number has been used";
        startBtn.disabled=false;
        return;
      }

      // 3️⃣ Mark subscription as used (UPDATED WITH SECRET KEY)
      await subRef.update({ 
        used: true, 
        usedAt: firebase.firestore.FieldValue.serverTimestamp(),
        access_key: "FLEXI_CBT_SECURE_2026" // Matches your security rules
      });

      // 4️⃣ Save locally for exam page
      localStorage.setItem("candidateName", formatName(name));
      localStorage.setItem("candidateWhatsApp", wa);

      status.style.color="#0b6623";
      status.textContent="✅ Access granted! Redirecting...";
      setTimeout(()=>window.location.href="page2.html", 1500);

    } catch(err){
      console.error(err);
      status.style.color="#b30000";
      // If the password doesn't match the rules, it hits this error block
      status.textContent="❌ Access Denied. Contact Admin.";
      startBtn.disabled=false;
    }
  });
  </script>
</body>
</html>
